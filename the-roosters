$install_puppet_master_centos7 = <<SCRIPT
peinstaller_url="$1"
peanswers_url="$2"
r10kyaml_url="$3"
master_hostname="$4"
master_domain="$5"
master_ip="$6"
web_proxy_ip_port="$7"
autosign_these_nodes="$8"
eyaml_private_key_url="$9"
eyaml_public_key_url="$10"

echo "Adding [$master_ip $master_hostname.$master_domain $master_hostname] to hosts file..."
sudo echo -e "$master_ip $master_hostname.$master_domain $master_hostname\n$(cat /etc/hosts)" > /etc/hosts

echo "Disabling firewall"
sudo systemctl mask firewalld ; sudo systemctl stop firewalld

if ! [ -z "$web_proxy_ip_port" ]; then
  echo "Adding temporary proxy for yum (to allow faster master install) [$web_proxy_ip_port]..."
  sudo echo "[main]\nproxy=$web_proxy_ip_port" > /etc/yum/yum.conf
  export http_proxy=$web_proxy_ip_port
fi

echo "Downloading puppet from $peinstaller_url and extracting to /tmp/peinstaller..." 
wget -q $peinstaller_url -O /tmp/peinstaller.tar.gz
mkdir /tmp/peinstaller
tar -xf /tmp/peinstaller.tar.gz --strip-components=1 -C /tmp/peinstaller

echo "Downloading answers file from $peanswers_url..."
curl -L $peanswers_url > /tmp/master.answers

echo "Installing puppet..."
sudo /tmp/peinstaller/puppet-enterprise-installer -a /tmp/master.answers

echo "Installing git, for r10k with shellgit..."
sudo yum install git -y

echo "Configuring r10k with puppet from $r10kyaml_url: $(curl -sL $r10kyaml_url)"
curl -L $r10kyaml_url > /etc/puppetlabs/r10k/r10k.yaml
sudo r10k deploy environment -pv

if ! [ -z "$proxy_ip_port" ]; then
  echo "Removing temporary proxy for yum (to allow faster master install) [$web_proxy_ip_port]..."
  sudo rm /etc/yum/yum.conf
fi

echo "Updating classes via classifier API..."
sudo curl -X POST https://$master_hostname.$master_domain:4433/classifier-api/v1/update-classes --cert /etc/puppetlabs/puppet/ssl/certs/$master_hostname.$master_domain.pem --key /etc/puppetlabs/puppet/ssl/private_keys/$master_hostname.$master_domain.pem --cacert /etc/puppetlabs/puppet/ssl/certs/ca.pem -v

echo "Adding the puppetclassify puppet gem..."
sudo puppet apply -e "package{'puppetclassify':ensure=>'0.1.0',provider=>'puppet_gem'}" -v
echo "Classifying nodes with a fork of the puppetclassify module (this will 404 on flushes but will create the groups and classify nodes...)"
sudo puppet apply -e "include 'profile::master_classifier'" -v

echo "Autosigning these nodes:[$autosign_these_nodes] using autosign.conf..."
sudo printf "\n$autosign_these_nodes" >> /etc/puppetlabs/puppet/autosign.conf

echo "Disabling automatic data binding"
sudo puppet config set data_binding_terminus none --section master

echo "Adding the hiera-eyaml puppet gem..."
sudo puppet apply -e "package{'hiera-eyaml':ensure=>'2.0.8',provider=>'puppet_gem'}" -v

echo "Adding hiera eyaml private key $eyaml_private_key_url: $(curl -sL $eyaml_private_key_url)"
curl -L $eyaml_private_key_url > /etc/puppetlabs/eyaml_private_key.pkcs7.pem
chmod 0400 /etc/puppetlabs/eyaml_private_key.pkcs7.pem 

echo "Adding hiera eyaml public key $eyaml_public_key_url: $(curl -sL $eyaml_public_key_url)"
curl -L $eyaml_public_key_url > /etc/puppetlabs/eyaml_public_key.pkcs7.pem
chmod 0400 /etc/puppetlabs/eyaml_public_key.pkcs7.pem

SCRIPT


$install_puppet_agent_linux = <<SCRIPT
master_ip="$1"
master_hostname="$2"
master_domain="$3"

echo "Adding [$master_ip $master_hostname.$master_domain $master_hostname] to hosts file..."
sudo echo -e "$master_ip $master_hostname.$master_domain $master_hostname\n$(cat /etc/hosts)" > /etc/hosts

echo "Disabling firewall"
sudo systemctl mask firewalld ; sudo systemctl stop firewalld

echo "Installing puppet from https://$master_hostname.$master_domain:8140/packages/current/install.bash..."
curl -k https://$master_hostname.$master_domain:8140/packages/current/install.bash | sudo bash

echo "Configuring puppet with master server $master_hostname.$master_domain..."
sudo puppet config set server $master_hostname.$master_domain

echo "Calling home..."
sudo sh -c "sudo puppet agent -t ; true" # supress non-zero exit code

SCRIPT


$install_puppet_agent_windows = <<SCRIPT
$master_ip=$Args[0]
$master_hostname=$Args[1]
$master_domain=$Args[2]
$peinstaller_url_windows=$Args[3]
$web_proxy_ip_port=$Args[4]

echo "Adding [$master_ip $master_hostname.$master_domain] to hosts file..."
add-content "C:\\Windows\\System32\\drivers\\etc\\hosts" "$master_ip $master_hostname.$master_domain"

echo "Downloading puppet from $peinstaller_url_windows $web_proxy_ip_port..."
wget $peinstaller_url_windows -outfile "c:\\windows\\temp\\puppet-enterprise-installer.msi" -Proxy $web_proxy_ip_port

echo "Installing puppet..."
Start-Process -FilePath msiexec -ArgumentList /i, "C:\\Windows\\Temp\\puppet-enterprise-installer.msi", /quiet -wait 

echo "Configuring puppet with master server $master_hostname.$master_domain..."
$env:Path += ";C:\\Program Files\\Puppet Labs\\Puppet\\bin"
puppet config set server, "$master_hostname.$master_domain"

SCRIPT
