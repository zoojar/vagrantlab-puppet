$install_puppet_master_centos7 = <<SCRIPT
peinstaller_url="$1"
peanswers_url="$2"
r10kyaml_url="$3"
master_hostname="$4"
master_domain="$5"
master_ip="$6"

echo "Adding [$master_ip $master_hostname.$master_domain $master_hostname] to hosts file..."
sudo echo -e "$master_ip $master_hostname.$master_domain $master_hostname\n$(cat /etc/hosts)" > /etc/hosts

echo "Disabling firewall"
sudo systemctl mask firewalld ; sudo systemctl stop firewalld

echo "Downloading puppet from $peinstaller_url and extracting to /tmp/peinstaller..." 
#apt-get install axel -y
wget -q $peinstaller_url -O /tmp/peinstaller.tar.gz
mkdir /tmp/peinstaller
tar -xf /tmp/peinstaller.tar.gz --strip-components=1 -C /tmp/peinstaller

echo "Downloading answers file from $peanswers_url..."
curl -L $peanswers_url > /tmp/master.answers

echo "Installing puppet..."
sudo /tmp/peinstaller/puppet-enterprise-installer -a /tmp/master.answers

echo "Configuring r10k with puppet from $r10kyaml_url: $(curl -sL $r10kyaml_url)"
curl -L $r10kyaml_url > /etc/puppetlabs/r10k/r10k.yaml
sudo r10k deploy environment -pv

SCRIPT


$install_puppet_agent_linux = <<SCRIPT
master_ip="$1"
master_hostname="$2"
master_domain="$3"

echo "Adding [$master_ip $master_hostname.$master_domain $master_hostname] to hosts file..."
sudo echo -e "$master_ip $master_hostname.$master_domain $master_hostname\n$(cat /etc/hosts)" > /etc/hosts

echo "Installing puppet from https://$master_hostname.$master_domain:8140/packages/current/install.bash..."
curl -k https://$master_hostname.$master_domain:8140/packages/current/install.bash | sudo bash

echo "Configuring puppet with master server $master_hostname.$master_domain..."
sudo puppet config set server $master_hostname.$master_domain

echo "Calling home..."
sudo sh -c "puppet agent -t ; true" # supress non-zero exit code

SCRIPT


$install_puppet_agent_windows = <<SCRIPT
$master_ip=$Args[0]
$master_hostname=$Args[1]
$master_domain=$Args[2]
$peinstaller_url_windows=$Args[3]

echo "Adding [$master_ip $master_hostname.$master_domain] to hosts file..."
add-content "C:\\Windows\\System32\\drivers\\etc\\hosts" "$master_ip $master_hostname.$master_domain"

echo "Downloading puppet from $peinstaller_url_windows..."
wget $peinstaller_url_windows -outfile "c:\\windows\\temp\\puppet-enterprise-installer.msi"

echo "Installing puppet..."
Start-Process -FilePath msiexec -ArgumentList /i, "C:\\Windows\\Temp\\puppet-enterprise-installer.msi", /quiet -wait 

echo "Configuring puppet with master server $master_hostname.$master_domain..."
$env:Path += ";C:\\Program Files\\Puppet Labs\\Puppet\\bin"
puppet config set server $master_hostname.$master_domain

echo "Calling home..."
start-process puppet.bat "agent -t" 

SCRIPT
